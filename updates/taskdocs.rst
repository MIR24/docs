..
 **************************
 Обновления
 **************************
Обновления. Подробное описание функционала реализованных задач.

Баннер в Публикациях
=====================
:ref:`Ссылка на инструкцию <update_publication>`

.. warning::

   Код баннера ``https://zen.yandex.ru/mir24tv`` Перенесен в баннерное место.
   Флаги включения баннера во всех публикациях проставляется автоматически!

Функциональные изменения
---------------------------
Код перенесен из текста всех публикаций и новостей в баннерное место, с использованием функционала через
баннерное место в конце текста публикуемой новости.

В конце текста `новостей <https://mir24.tv/news/list/all>`_

Реализация интерфейса
------------------------------------------------
В интерфейсе редактирования публикации добавлены флаги включения баннера:

* Выводить баннеры в конце текста кроме amp-страниц
* Выводить баннеры в конце текста для amp-страниц

____

Новый раздел "Статичные файлы"
=========================================
:ref:`Ссылка на инструкцию <uploadfile>`

Реализована загрузка статичных файлов на сервер и интерфейс управления загруженными файлами.

Реализация интерфейса
------------------------------------------------
Интерфейс реализован в отдельном меню статичные файлы.

Переход в интерфейс управления осуществляется из пункта "статичные файлы" раздела "Служебные", расположенного в меню навигации Административного Административного интерфейса.

Требования к формату загружаемых файлов
------------------------------------------------
* К загрузке допустимы все принятые на веб, графические и текстовые форматы:

    *  ``*.pdf``
    *  ``*.txt``
    *  ``*.pptx``
    *  ``*.ppt``
    *  ``*.docx``
    *  ``*.doc``
    *  ``image/*``
    *  ``*.xls``
    *  ``*.xlsx``

* В названии файла необходимо использовать только английские буквы, цифры и символы "-" и "_".

Описание интерфейса и функционала
----------------------------------------------------------------

* Список файлов представлен листом. Сортировка:

    * По убыванию даты загрузки файлов. (Каждый новый файл сверху списка);

* В случае если загружаемый файл содержит одинаковое имя с уже имеющимся, происходит загрузка с заменой имеющегося на новый;

* Формирование ссылки на файл зависит от конфигураций (если cdn включен то с cdn).

____

Лента новостей
==================
На страницах сайта mir24.tv реализована лента новостей, по аналогии ленты на сайте ria.ru.

Реализована всплывающая "Лента новостей", предоставляющая дополнительные функциональные возможности для представления и навигации по публикуемым материалам, на сайте mir24.tv.

Реализация интерфейса
-----------------------
 * "Лента новостей" является сквозным, для всех страниц сайта, структурным элементом страницы:

    * элемент расположен в нижней части страницы;

    * элемент является интерактивным виджетом, зафиксирован при прокрутке страницы.

Описание функционала
-----------------------

* Виджет "Лента новостей" имеет интерактивные свойства:

    * Отображение ленты. Активное состояние. Отображается 2 публикации. При клике происходит раскрытие ленты;

    * Раскрытие ленты. Раздвигается слой с публикациями:

        * Слой публикаций, содержащий данные в виде: "<Время> <Заголовок>". Слой содержит ссылки на публикации в заголовке.

        * Отображается более 10 публикаций в зависимости от получившегося размера слоя с публикациями.

        * При прокрутке элементов слоя публикаций происходит дополнительный отбор.

    * Скрытие ленты. Лента скрывается из нижней части страницы. Отображается элемент в виде кнопки "Лента новостей" для отображения ленты.

* Виджет "Лента новостей" имеет следующие условия отбора данных:

    * Отбираются публикации у которых:

        * "Тип публикации" имеет значение "Новости"
        * Новость содержит признак "Опубликована"

    * Первый отбор. Отбираются Новости массивом по времени публикации, в количестве 30 штук;

    * Дополнительный отбор. Отобранный в "Слой публикаций" раскрытой ленты массив вида "<Время> <Заголовок>" дополняется в количестве 10 штук.

____

Врезка видео YouTube
=======================

Реализована автоматическая врезка встраиваемого видео из YouTube. Видео встраивается по ``ID-видео`` YouTube в соответствующее поле, имеющее автоматическую валидацию.

Описание функционала
-------------------------
| В поле "ID видео на YouTube" вставляется ссылка вида: ``HRzi8-xBJ9Q``.
| Данная ссылка является ``ID-видео`` в YouTube.
| :code:`youtube.com/watch?v={ID-видео}`
| Например, находясь на странице видео, ссылка в адресной строке:
| :code:`youtube.com/watch?v=HRzi8-xBJ9Q`
| ``{ID-видео}`` в данном случае: :code:`HRzi8-xBJ9Q` расположено после: :code:`/watch?v=`.


 * Добавлено поле "ID видео на YouTube":

    * Поле расположено на формах редактирования публикаций:

        * Новости
        * Видео
        * Фотоленты
        * Статьи
        * Интерактив
        * Лица Мира
        * Пресс-релизы

 * Добавлена валидация ссылки, получаемой в результате указания ID-видео YouTube, в виде пиктограмм:

    * |sucss| Валидация успешна, ID-видео является корректным.
    * |fail| Валидация прошла неудачно, указанное значение в поле не является корректным, нет видео с данным ID на YouTube.


.. |sucss| image:: /images/youtube-sucss.jpg
.. |fail| image:: /images/youtube-fail.jpg

____

.. _google-analytics:

Статистика просмотров новостей в админке
==========================================
Админка. Google-Аналитика. Статистика просмотров. Реализован отчет о статистике просмотров новостей.
Для работы функционала необходимы *ключи для Google.API аналитики*

| Файл с aouth данными, хранится по ссылке: - Mir24tv-5775418f0ca5.json_;
| Google view id: account-explorer_;
| GA_MEASUREMENT_ID – на идентификатор отслеживания ресурса Google Аналитики.
|

.. _Mir24tv-5775418f0ca5.json: https://mir24tv.atlassian.net/secure/attachment/25210/Mir24tv-5775418f0ca5.json
.. _account-explorer: https://ga-dev-tools.appspot.com/account-explorer/

.. image:: /images/admin/analytics-stat.jpg
   :width: 30 %
   :align: right

|
Реализованный отчет о статистике просмотров расположен в меню админки по кнопке: "Google аналитика".

|


Описание функционала
-------------------------
 * Статистика просмотров новостей google analytics запрашивается от сервиса Google.API.
 * Полученный ответ от Google.API сохраняется, согласно модели статистики для последующего использования ее в отчетах.

|

 * Формирование отчета о статистике просмотров, включает:

      * Все материалы за произвольный день,
      * за последнюю неделю,
      * за последний месяц,
      * за последний квартал и последний год

|

 * Материалы группируются по entity_id, статистика берется из модели статистики если есть, если нет, запрашивается из Google.API.

 * Сортировка по кол-ву просмотров.

 * Отчет в виде таблицы, где строка это:

.. csv-table:: Statistic
   :header: Data
   :widths: 30

   "ссылки на материалы (Титулы, тип новость/статья)"
   "дата публикации материала"
   "Автор материала (создатель)"
   "кол-во просмотров"
   "кол-во уникальных просмотров"


Запрос статистики от Google.API
------------------------------------------------
| Для накопления статистики и последующего использования ее в отчетах, статистика хранится по дням.
| Получив ответ от Google.API на запрос статистики, ответ разбивается на дни и сохраняет 7 периодов.

 * Время запроса статистики от 00:00 до 23:59 заданной даты;

 * В случае если статистика на запрошенный материал есть в таблице и это прошедший период (complete = true), то статистика рассчитывается из сохраненной таблицы.

 * Если статистика на запрошенный материал есть в сохраненной таблице, но период не закрыт (complete = false), то:

      * Статистику запрашивали меньше пяти минут назад - расчет из сохраненной таблицы;
      * Иначе выполняется запрос от Google.API и сохраняется в таблице.

 * Если статистика отсутствует и она за **прошлый** период, то выполняется запрос от Google.API и сохраняется с флагом complete = ``true``;
 * Если статистика отсутствует и она за **текущий** период, то необходимо выполняется запрос от Google.API и сохраняется с флагом complete = ``false``.

Крон задача по получению статистики по материалам текущего дня
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Раз в 10 минут (настройка в конфиг) опрашивать все материалы текущего дня на предмет статистики и сохранять в таблицу.

Модель статистики для таблицы сохраненных ответов
-----------------------------------------------------
| Что бы исключить постоянные обращения к Google.API *(количество обращений лимитировано)*, полученные от Google результаты необходимо сохранять в таблицу.
| Структура таблицы:

.. csv-table:: Response
   :header: "Response Data", type
   :widths: 20, 30

   "ID записи", "(uint8,autoincrement)"
   "entity_id", "( = entity_id news table)"
   "url", "(нужно для быстрого поиска по url)"
   "from_datetime", "(timestamp)"
   "unique_views", "(uint8)"
   "total_views", "(uint8)"
   "complete", "(true,false)"

*Флаг complite ставится когда был запрос статистики за прошедший период, а значит он не может уже измениться.*

____
